#!/bin/bash

# This file will create a file.ssm.gpg file for each file listed in .ssm/secret_files
# The files will be decryptable by all GPG keys listed in .ssm/gpg_keys

# Get current dir (bin dir)
BIN_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
SSM_DIR="$BIN_DIR/.."
# Source setup support file
source "$SSM_DIR/lib/setup"

# Build gpg recipients part of gpg command
gpg_recipients_part=""
for gpg_key in ${gpg_keys[*]}; do    
    echo "[INFO] Adding key $gpg_key as recipient"
    gpg_recipients_part="$gpg_recipients_part --recipient $gpg_key "
done

# Encrypt files
echo "[INFO] Encrypting files:"
for file in ${secret_files[*]}; do
    echo "[INFO] Encrypting file '$file'"
    cmd="gpg -q --with-colons --encrypt --yes $gpg_recipients_part -o $file.ssm.gpg $file"
    ${cmd}
done